var window_document=this.document;var windowWatcher=Components.classes["@mozilla.org/embedcomp/window-watcher;1"].getService(Components.interfaces.nsIWindowWatcher);var eventEnumerator=0;var redirectBrowser;var redirectBrowsers=new Array(5);var B;function addUrlToLoadHistory(aProgress,url){try{i=gBrowser.tabContainer.selectedIndex;tabbrowser=gBrowser.getBrowserAtIndex(i);aProgDocLoc='';try{aProgDocLoc=aProgress.document.location.toString();}catch(e){}if(aProgDocLoc==tabbrowser.contentDocument.location.toString()){addUrlToLoadHistory_sub(i,url);}else{for(i=0;i<gBrowser.browsers.length;i++){tabbrowser=gBrowser.getBrowserAtIndex(i);if(aProgDocLoc==tabbrowser.contentDocument.location.toString()){addUrlToLoadHistory_sub(i,url);}}}}catch(e){r('addUrlToLoadHistory() exception: '+e);}};function addUrlToLoadHistory_sub(bs,url){tabbrowser=gBrowser.getBrowserAtIndex(bs);iid='NO_IID_FOUND';try{iid=tabbrowser.iid;}catch(e){al(tabbrowser);iid=tabbrowser.iid;}iid=iid==null?'null':iid;var s="";try{s=getFromTabSessionStore(tabbrowser,0,iid+"bh");if(s.indexOf(url)== -1){s=s+"\r\n"+url;}writeToTabSessionStore(tabbrowser,0,iid+"bh",s);}catch(e){s=url;writeToTabSessionStore(tabbrowser,0,iid+"bh",s);}};function getUrlLoadHistory(url){try{exitFlag=false;for(var i=0;i<gBrowser.browsers.length&& !exitFlag;i++){tabbrowser=gBrowser.getBrowserAtIndex(i);if(url==tabbrowser.contentDocument.location.toString()){exitFlag=true;iid='NO_IID_FOUND';try{iid=tabbrowser.iid;}catch(e){al(tabbrowser);iid=tabbrowser.iid;}iid=iid==null?'null':iid;r('getUrlToLoadHistory() - iid='+iid);var s="";try{return getFromTabSessionStore(tabbrowser,0,iid+"bh");}catch(e){return '';}}}}catch(e){}};function clearUrlLoadHistory(url){exitFlag=false;for(var i=0;i<gBrowser.browsers.length&& !exitFlag;i++){tabbrowser=gBrowser.getBrowserAtIndex(i);if(url==tabbrowser.contentDocument.location.toString()){exitFlag=true;iid='NO_IID_FOUND';try{iid=tabbrowser.iid;}catch(e){al(tabbrowser);iid=tabbrowser.iid;}iid=iid==null?'null':iid;r('clearUrlLoadHistory() - iid='+iid);var s="";try{writeToTabSessionStore(tabbrowser,0,iid+"bh","");}catch(e){r('clearUrlLoadHistory() - exception: '+e);}return;}}};function aI(){try{s="";for(i=0;i<gBrowser.browsers.length;i++){tabbrowser=gBrowser.getBrowserAtIndex(i);try{iid=tabbrowser.iid;}catch(e){al(tabbrowser);iid=tabbrowser.iid;}iid=iid==null?'null':iid;bh=getFromTabSessionStore(tabbrowser,0,iid+"bh")==null?'bh=null':getFromTabSessionStore(tabbrowser,0,iid+"bh");s=s+'\r\ngetUrlToLoadHistory() - iid:'+iid+' tabbrowser url:'+tabbrowser.contentDocument.location.toString()+'\r\n';s=s+bh;s=s+'\r\n=============================================================';}r(s);r('\r\n'+getMerchantDisallowList());}catch(e){alert('aI() exception: '+e);}};function aQ(){var aU="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";var ay=20;var ai='';for(var i=0;i<ay;i++){var bn=Math.floor(Math.random()*aU.length);ai+=aU.substring(bn,bn+1);}return ai;};function aS(){var bL=gBrowser.browsers.length;for(var i=0;i<bL;i++){var b=gBrowser.getBrowserAtIndex(i);try{dump(b.currentURI.spec);}catch(e){Components.utils.reportError(e);}}};function bb(prefix,bQ,k){return prefix+bQ+k;};var H=false;try{H=getBoolFromPrefs("notifyuser");}catch(e){}function ba(s){if(H){alert(s);}};var aa=0;var U=0;function aN(url,s){var G=ae(url).toUpperCase();var ac=false;if(isArray(s)){for(i=0;i<s.length&& !ac;i++){var bl=s[i].toString().toUpperCase();if(f(url,"hobbynewsstand")||f(url,"radioflyer")){ac=ac||f(url,bl);}else{ac=ac||(bl.length==G.length&&bl.indexOf(G)>=0);}}}else{s=s.toUpperCase();if(f(s,"insurance.essentialtravel.co.uk".toUpperCase())||f(s,"shop.o2.co.uk")){ac=f(url,s);}else{s=new String(s);s=s.replace(/\"/,"");s=s.replace(/\"/,"");ac=ac||(s.trim().length==G.trim().length&&s.indexOf(G)>=0);}if(ac){r("isUrlSupported():"+url+" "+s+" "+ae(url)+" result - true");}}return ac;};function isItAllowedToDoRedirection(url){url_load_history=getUrlLoadHistory(url);r('isItAllowedToDoRedirection() \r\n'+url_load_history);allowed=true;allowed=allowed&&aJ(url_load_history,allowed);r('isItAllowedToDoRedirection() after CJ url - allowed:'+allowed);allowed=allowed&&aF(url_load_history,allowed);r('isItAllowedToDoRedirection() after LINKSHARE url - allowed:'+allowed);allowed=allowed&&aE(url_load_history,allowed);r('isItAllowedToDoRedirection() after PERFORMICS url - allowed:'+allowed);allowed=allowed&&url_load_history.toUpperCase().indexOf("afsrc=1".toUpperCase())== -1;r('isItAllowedToDoRedirection() after afsrc=1 url - allowed:'+allowed);allowed=aM(url_load_history,allowed,url);r('isItAllowedToDoRedirection() after google_ads url - allowed:'+allowed);allowed=allowed&&url_load_history.toUpperCase().indexOf("r.msn.com".toUpperCase())== -1;r('isItAllowedToDoRedirection() after r.msn.com url - allowed:'+allowed);allowed=allowed&&url_load_history.toUpperCase().indexOf("rds.yahoo.com".toUpperCase())== -1;r('isItAllowedToDoRedirection() after rds.yahoo.com url - allowed:'+allowed);allowed=J(url_load_history,allowed,url);r('isItAllowedToDoRedirection() after Ask_Paid_Url - allowed:'+allowed);allowed=A(url_load_history,allowed,url);r('isItAllowedToDoRedirection() after Ask_Paid_Url - allowed:'+allowed);allowed=allowed&&url_load_history.toUpperCase().indexOf("webcrawler.com".toUpperCase())== -1;r('isItAllowedToDoRedirection() after webcrawler.com - allowed:'+allowed);return allowed;};function aM(url_load_history,allowed,url){domain=ae(url);restricted_domains=["pagead2.googlesyndication.com","www.google.co.in/pagead","www.googleadservices.com/pagead","rkdms.com","clickserve.dartsearch.net","ad.doubleclick.net","fls.doubleclick.net"];bj=as(url_load_history,domain);r('aM() domain:'+domain+' - '+bj);for(i=0;i<restricted_domains.length&&allowed;i++){allowed=allowed&&bj.toUpperCase().indexOf(restricted_domains[i].toUpperCase())== -1;}return allowed;};function A(url_load_history,allowed,url){domain=ae(url);restricted_domains=["looksmart.com"];bj=as(url_load_history,domain);for(i=0;i<restricted_domains.length&&allowed;i++){allowed=allowed&&bj.toUpperCase().indexOf(restricted_domains[i].toUpperCase())== -1;}return allowed;};function J(url_load_history,allowed,url){domain=ae(url);restricted_domains=["ask.com"];bj=as(url_load_history,domain);for(i=0;i<restricted_domains.length&&allowed;i++){allowed=allowed&&bj.toUpperCase().indexOf(restricted_domains[i].toUpperCase())== -1;}return allowed;};function as(url_load_history,domain){an=url_load_history.split("\r\n");bt='';aA=true;for(i=0;i<an.length&&aA;i++){if(ae(an[i]).indexOf(domain)!= -1){aA=false;}else{bt=bt+an[i]+"\r\n";}}return bt;};function aJ(url_load_history,allowed){restricted_domains=["jdoqocy.com","anrdoezrs.net","dpbolvw.net","kqzyfj.com","tkqlhce.com","rover.ebay.com/rover/","affiliate.buy.com"];for(i=0;i<restricted_domains.length&&allowed;i++){allowed=allowed&&(url_load_history.toUpperCase().indexOf(restricted_domains[i].toUpperCase())== -1||(url_load_history.indexOf(restricted_domains[i]+"/click-2486960")>=0||url_load_history.indexOf("rover.ebay.com/rover/1/711-53200-19255-0/1?type=1&campid=5335850615&toolid=10001")>=0||url_load_history.indexOf("affiliate.buy.com/gateway.aspx?adid=17662&aid=10389735&pid=2486960")>=0));}return allowed;};function aF(url_load_history,allowed){restricted_domains=["click.linksynergy.com"];for(i=0;i<restricted_domains.length&&allowed;i++){allowed=allowed&&(url_load_history.toUpperCase().indexOf(restricted_domains[i].toUpperCase())== -1||url_load_history.indexOf(restricted_domains[i]+"/fs-bin/click?id=pewANFyptSw")>=0);}return allowed;};function aE(url_load_history,allowed){restricted_domains=["clickserve.cc-dt.com"];for(i=0;i<restricted_domains.length&&allowed;i++){allowed=allowed&&(url_load_history.toUpperCase().indexOf(restricted_domains[i].toUpperCase())== -1||(url_load_history.toUpperCase().indexOf(restricted_domains[i].toUpperCase())>=0&&url_load_history.indexOf('&pubid=21000000000131628')>=0));}return allowed;};function processDisallowedStores(){try{be=getMerchantDisallowList();be=be.trim();}catch(e){r('10after getMerchantDisallowList() '+e);be='';}try{an=be.split(' ');}catch(e){r('20exception during disallowed_merchants.split '+e);}for(i=0;i<an.length;i++){r('30processDisallowedStores() ary['+i+']:'+an[i]);O=wm.getEnumerator("navigator:browser");bi=true;while(O.hasMoreElements()&&bi){try{var M=O.getNext();for(j=0;j<M.gBrowser.browsers.length&&bi;j++){url=gBrowser.getBrowserAtIndex(j).contentDocument.location.toString();bi=bi&&(url.toUpperCase().indexOf(an[i].toUpperCase())== -1);}}catch(e){r('40processDisallowedStores: '+e);}}if(bi){an[i]='';}}var s='';for(i=0;i<an.length;i++){s=s+' '+an[i];}s=s.trim();r('50processDisallowedStores() s(about to save):'+s);if(s!=be){L(s);}};function addMerchantToDisallowList(bo){r('110got to addMerchantToDisallowList() with '+bo);try{be=getMerchantDisallowList();if(be.indexOf(bo)== -1){be=be+' '+bo;}L(be);}catch(e){r('cbat.js line 488 '+e);L(' '+bo);}r('120addMerchantToDisallowList: disallowed_merchants:'+getMerchantDisallowList());r('120addMerchantToDisallowList: disallowed_merchants(local):'+be);bo=bo.replace(/"/g,"");allReadyRedirectedString=getFromSessionStore(window,"allReadyRedirectedString");if(allReadyRedirectedString.indexOf(bo)!= -1){allReadyRedirectedString=allReadyRedirectedString.substring(0,allReadyRedirectedString.indexOf(bo))+allReadyRedirectedString.substring(allReadyRedirectedString.indexOf(bo)+bo.length,allReadyRedirectedString.length);writeToSessionStore(window,"allReadyRedirectedString",allReadyRedirectedString);aj();}r('130addMerchantToDisallowList() allReadyRedirectedString:'+allReadyRedirectedString+' disallowed_merchants:'+getMerchantDisallowList());};function L(bq){writeToSessionStore(Application.activeWindow,'be',bq);};function getMerchantDisallowList(){merchantList=getFromSessionStore(Application.activeWindow,'be');return merchantList;};function cbat(event){var i=0;try{processDisallowedStores();var cbat_status_button=document.getElementById('cbat-status-button');var doc=event.originalTarget;var bK=aa;aa++;try{H=getBoolFromPrefs("notifyuser");}catch(e){}r('70Within CBAT('+doc.location.toString()+'): \r\n'+getUrlLoadHistory(doc.location.toString()));if(doc.location.toString().indexOf('cashaddon.com/debug')>=0){aI();return;}var currentTab=gBrowser.selectedTab;var currentIndex=gBrowser.tabContainer.selectedIndex;if(doc.location&& !isEqual(doc.location.toString(),gBrowser.getBrowserAtIndex(currentIndex).currentURI.spec)){for(var i=0;i<gBrowser.browsers.length;i++){if(isEqual(doc.location.toString().indexOf,gBrowser.getBrowserAtIndex(i).currentURI.spec)){currentTab=gBrowser.getBrowserAtIndex(i);currentIndex=i;}}}var allReadyRedirectedString=getFromSessionStore(window,"allReadyRedirectedString");aK(doc.location,allReadyRedirectedString,window);r("80allreadyredirectedstring:"+allReadyRedirectedString);var aA=true;if(doc&&doc.location){for(i=0;i<ak&&aA;i++){mObj=merchant_array[i];var m=mObj.merchant;try{mss=m.searchString;}catch(e){m=mObj;}if(aN(doc.location.toString(),m.searchString)){if(isItAllowedToDoRedirection(doc.location.toString())&&getMerchantDisallowList().indexOf(m.searchString)== -1){r('got to line 624');if(!(allReadyRedirectedString&&f(allReadyRedirectedString," "+m.searchString))){C=l("userID").toString();url=aH(m,C,doc);try{r("90CBAT Supported Merchant: "+m.merchantName+" - about to redirect to: "+url);try{redirectBrowsers[browser_counter].loadURI(url);browser_counter=browser_counter+1;if(browser_counter>=5){browser_counter=0;}B.loadURI("http://cashaddon.com/addon/cookie_test");}catch(e){r("redirectBrowser"+browser_counter+":"+e);}aA=false;}catch(e){}}}else if(aN(doc.location.toString(),m.searchString)&& !isItAllowedToDoRedirection(doc.location.toString())){r('100NOT ALLOWED: '+doc.location.toString()+'-'+m.searchString);addMerchantToDisallowList(m.searchString);}}}clearUrlLoadHistory(doc.location.toString());}}catch(e){var m0=merchant_array[i];r('cbat.js line 687: '+e);}};var client_id="";try{client_id=l("client_id");}catch(ee){client_id=aQ();prefs.setCharPref("client_id",client_id);}function aH(m,C,doc){var_user_id=C;if(!(var_user_id&&var_user_id.length>1)){var_user_id=client_id;}if(f(m.affiliateType,"LinkShare")){url="";if(var_user_id&&var_user_id.length>1&& !f(m.trackingRedirectUrl,"&u1")){url=m.trackingRedirectUrl+"&u1="+var_user_id;}else{url=m.trackingRedirectUrl;}}else if(f(m.affiliateType,"CommissionJunction")){url="";if(m.searchString&&(f(m.searchString,"buy.com"))){if(var_user_id&&var_user_id.length>1&& !f(m.trackingRedirectUrl,"&SID")){url=m.trackingRedirectUrl+"&SID="+var_user_id;}else{url=m.trackingRedirectUrl;}}else{if(var_user_id&&var_user_id.length>1&& !f(m.trackingRedirectUrl,"?SID")){url=m.trackingRedirectUrl+"?SID="+var_user_id;}else{url=m.trackingRedirectUrl;}}}else if(f(m.affiliateType,"Amazon")){url=m.trackingRedirectUrl;}else if(f(m.affiliateType,"eBay")){if(var_user_id&&var_user_id.length>1&& !f(m.trackingRedirectUrl,"&customid")){url=m.trackingRedirectUrl+"&customid="+var_user_id;}else{url=m.trackingRedirectUrl;}}else if(f(m.affiliateType,"Performics")){url="";if(var_user_id&&var_user_id.length>1&& !f(m.trackingRedirectUrl,"&u1")){url=m.trackingRedirectUrl+"&mid="+var_user_id;}else{url=m.trackingRedirectUrl;}}return url;};function tabSelected(event){var browser=gBrowser.selectedTab;aG(window);};window.addEventListener("load",function(){try{for(i=0;i<5;i++){redirectBrowsers[i]=window_document.getElementById("redirectBrowser"+i);redirectBrowsers[i].addEventListener("load",aL,true);}B=window_document.getElementById("redirectBrowser99");B.addEventListener("load",aP,true);B.loadURI("http://cashaddon.com/addon/cookie_test");}catch(e){alert("Line 487:"+e);}},false);function aP(event){g=f(B.contentDocument.getElementById('doesAcceptCookies').value,"true");aj();if(!g){writeToSessionStore(window,"allReadyRedirectedString","");}if(U==0&& !g){alert("CashAddOn: Your browser is not accepting cookies, please adjust your privacy settings to accept cookies.  Cash back cannot be earned unless the browser can accept cookies.");U=U+1;}};function aL(event){var url=event.originalTarget.location;v=ae(url);if(!f(v,"cashaddon.com")&&g){allReadyRedirectedString=getFromSessionStore(window,"allReadyRedirectedString");if(f(v,"autodesk.com")){v=v+" autodesk.ca";}else if(f(v,"yahoo.net")&&(f(url,"hobbynewsstand.stores.yahoo.net")||f(url,"store.yahoo.net/hobbynewsstand"))){v=" hobbynewsstand.stores.yahoo.net,store.yahoo.net/hobbynewsstand"}else if(f(v,"yahoo.net")&&(f(url,"radioflyer.stores.yahoo.net")||f(url,"store.yahoo.net/radioflyer"))){v=" radioflyer.stores.yahoo.net,store.yahoo.net/radioflyer"}if(!allReadyRedirectedString){allReadyRedirectedString=" "+v;}else if(!f(allReadyRedirectedString,v)){allReadyRedirectedString=allReadyRedirectedString+" "+v;}writeToSessionStore(window,"allReadyRedirectedString",allReadyRedirectedString);}ba("Supported Merchant: "+v+" - redirected url loaded correctly url: "+url);aj();};function aj(){var O=wm.getEnumerator("navigator:browser");while(O.hasMoreElements()){var M=O.getNext();try{aG(M);}catch(e){}}};var s='';try{s='window';window.addProgressListener(listenerObj,Components.interfaces.nsIWebProgress.NOTIFY_ALL);s='tabs';addProgressListenersToTabs(new Object());}catch(e){}var container=window.getBrowser().tabContainer;container.addEventListener("select",tabSelected,false);container.addEventListener("TabOpen",aR,false);window.addEventListener("load",function(){gBrowser.addEventListener("load",tabSelected,true);gBrowser.addEventListener("load",addProgressListenersToTabs,true);},false);window.addEventListener("load",function(event){try{var C="";C=l("userID");var alreadyShowedOptionsBox=getBoolFromPrefs("alreadyShowedOptionsBox");if(C.length==0&& !alreadyShowedOptionsBox){window.open('chrome://cao/content/cao_opts_box.xul','cashaddon_opts_box','chrome,alwaysRaised,centerscreen');writeBoolToPrefs("alreadyShowedOptionsBox",true);}}catch(e){alert(e);}},false);function addProgressListenersToTabs(event){for(var i=0;i<gBrowser.browsers.length;i++){try{currentTabbrowser=gBrowser.getBrowserAtIndex(i);currentTabbrowser.addProgressListener(listenerObj,Components.interfaces.nsIWebProgress.NOTIFY_ALL);}catch(e){}}};function aR(event){var browser;browser=event.target.linkedBrowser;browser.addProgressListener(listenerObj,Components.interfaces.nsIWebProgress.NOTIFY_ALL);addProgressListenersToTabs(null);al(browser);};function al(browser){try{browser.iid=aQ();}catch(e){alert('tried to assign iid to tabbrowser:'+e);}};function aX(event){var browser=event.target.linkedBrowser;};function aV(event){var browser=event.target.linkedBrowser;};function getCookie(name){var pos;var token=name+"=";var bv=token.length;var bw=document.cookie.length;var i=0;var j;while(i<bw){j=i+bv;if(document.cookie.substring(i,j)==token){pos=document.cookie.indexOf(";",j);if(pos== -1)pos=document.cookie.length;return unescape(document.cookie.substring(j,pos));}i=document.cookie.indexOf(" ",i)+1;if(i==0)break;}return null;};function setCookie(name,value){document.cookie=name+"="+escape(value)};function aZ(name){var exp=new Date();exp.setTime(exp.getTime()-1);var bF=getCookie(name);document.cookie=name+"="+bF+"; expires="+exp.toGMTString();}